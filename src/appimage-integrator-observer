#!/bin/bash

#     _               ___
#    / \   _ __  _ __|_ _|_ __ ___   __ _  __ _  ___
#   / _ \ | '_ \| '_ \| || '_ ` _ \ / _` |/ _` |/ _ \
#  / ___ \| |_) | |_) | || | | | | | (_| | (_| |  __/
# /_/   \_\ .__/| .__/___|_| |_| |_|\__,_|\__, |\___|
#         |_|   |_|                       |___/
#  ___       _                       _
# |_ _|_ __ | |_ ___  __ _ _ __ __ _| |_ ___  _ __
#  | || '_ \| __/ _ \/ _` | '__/ _` | __/ _ \| '__|
#  | || | | | ||  __/ (_| | | | (_| | || (_) | |
# |___|_| |_|\__\___|\__, |_|  \__,_|\__\___/|_|
#                    |___/
#
# Author Andrianos Papamarkou
# Email: apapamarkou@yahoo.com
#
# This script is the observer service
# for the Appimage Integrator.
# It watches the Applications folder
# for new AppImages and calls the
# processing script when a new AppImage
# is detected. It also calls the cleanup
# script when an AppImage is deleted or
# moved out of the Applications folder.
# The script uses inotifywait to monitor
# the Applications folder for changes.
# It also checks if another instance of
# the script is running and exits if it does.
# The script is designed to run in the
# background and notify the user when
# an AppImage is detected or when the
# script exits.

set -euo pipefail

# Source logging functions
source "$(dirname "$0")/logging.sh"
# Source notification functions
source "$(dirname "$0")/notify.sh"
# Source translation functions
source "$(dirname "$0")/messages.sh"

# exit on logout
trap 'log info "Cleaning up..."; exit' EXIT

# Ensure single instance 

# Get the name of the script (the script's basename)
SCRIPT_NAME=$(basename "$0")

# Get the PID of the current script
CURRENT_PID=$$

# Get all same script PIDs
PIDS_FOUND=$(pidof -x "$SCRIPT_NAME")

# Remove the current instance PID from the PIDs found
OTHER_PIDS=$(echo "$PIDS_FOUND" | sed "s/$CURRENT_PID//")

# Check is OTHER_PIDS except for CURRENT_PID exist
if [ -n "$OTHER_PIDS" ]; then
    log warning "$(get_translated "ANOTHER_INSTANCE_RUNNING")"
    exit 1
fi

# Define the directories and scripts

config_user="$HOME/.config/appimage-integrator/appimage-integrator.conf"
config_system="/etc/appimage-integrator/appimage-integrator.conf"

if [[ -f "$config_user" ]]; then
  source "$config_user"
elif [[ -f "$config_system" ]]; then
  source "$config_system"
else
  # Hard coded variables if no config found
  appimage_integrator_root="$HOME/.local/bin/appimage-integrator"
  watch_directory="$HOME/Applications"
fi

# Introduce Applications folder if not exist
mkdir -p "$watch_directory"

# Also watch Downloads folder
downloads_directory="$HOME/Downloads"
mkdir -p "$downloads_directory"

processing_script="$appimage_integrator_root/appimage-integrator-extract"
cleanup_script="$appimage_integrator_root/appimage-integrator-cleanup"

# Ensure both scripts exist and are executable
if [[ ! -x "$processing_script" ]]; then
    notify "$(get_translated "ERROR")" "$(get_translated "PROCESSING_SCRIPT_NOT_FOUND"). $(get_translated "INTEGRATION_NOT_RUNNING")."
    log err "$(get_translated "PROCESSING_SCRIPT_NOT_FOUND"). $(get_translated "INTEGRATION_NOT_RUNNING")."
    exit 1
fi

if [[ ! -x "$cleanup_script" ]]; then
    notify "$(get_translated "ERROR")" "$(get_translated "CLEANUP_SCRIPT_NOT_FOUND"). $(get_translated "INTEGRATION_NOT_RUNNING")."
    log err "$(get_translated "CLEANUP_SCRIPT_NOT_FOUND"). $(get_translated "INTEGRATION_NOT_RUNNING")."
    exit 1
fi

# Start watching the directories
log info "$(get_translated "WATCHING") $watch_directory and $downloads_directory"
inotifywait -m -e create,moved_to,delete,moved_from "$watch_directory" "$downloads_directory" | while read -r directory event file; do
	log debug "$(get_translated "EVENT") = $event $file in $directory"
    
    # Check if event is in Downloads
    if [[ "$directory" == "$downloads_directory/" ]]; then
        if [[ "$event" == *"CREATE"* || "$event" == *"MOVED_TO"* ]]; then
            if [[ "${file,,}" == *.appimage ]]; then
                log info "AppImage detected in Downloads: $file"
                full_path="$directory$file"
                # Call downloaded handler script in background
                "$appimage_integrator_root/appimage-integrator-downloaded" "$full_path" &
            fi
        fi
    # Check if event is in Applications
    elif [[ "$directory" == "$watch_directory/" ]]; then
        # Check if the event is related to adding AppImages
        if [[ "$event" == *"CREATE"* || "$event" == *"MOVED_TO"* ]]; then
            if [[ "${file,,}" == *.appimage ]]; then
                log info "$(get_translated "NEW_APPIMAGE_DETECTED"): $file"
                full_path="$directory$file"
                # Call your processing script with the AppImage as an argument
                "$processing_script" "$full_path"
            fi
        # if the event is related to deleting or moving out AppImages
        elif [[ "$event" == *"DELETE"* || "$event" == *"MOVED_FROM"* ]]; then
            if [[ "${file,,}" == *.appimage ]]; then
                log info "$(get_translated "APPIMAGE_DELETED"): $file"
                full_path="$directory$file"
                # Call your cleanup script with the AppImage as an argument
                "$cleanup_script" "$full_path"
            fi
        fi
    fi
done
