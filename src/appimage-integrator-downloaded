#!/bin/bash

# Source logging functions
source "$(dirname "$0")/logging.sh"
# Source notification functions
source "$(dirname "$0")/notify.sh"
set -euo pipefail

# Check if an argument was provided
if [ $# -ne 1 ]; then
    echo "Usage: $0 <AppImage>"
    exit 1
fi

# Wait until the file is finished downloading
wait_for_file_copy() {
    local file="$1"
    local previous_size=0
    local current_size=0
    local stable_count=0

    while true; do
        if [ -f "$file" ]; then
            current_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            
            if [ "$current_size" = "$previous_size" ]; then
                stable_count=$((stable_count + 1))
                # If file size remains same for 3 checks (3 seconds), consider it complete
                if [ $stable_count -ge 3 ]; then
                    break
                fi
            else
                stable_count=0
            fi
            
            previous_size=$current_size
        fi
        sleep 1
    done
}

appimage="$1"
appimage_full_name="${appimage##*/}"
appimage_name="${appimage_full_name%%.*}"

# Wait for download to complete
log info "Waiting for download to complete: $appimage_name"
wait_for_file_copy "$appimage"

# Notify user with integrate action
notify "AppImage Integrator" "$appimage_name appeared in Downloads." "Integrate $appimage_name" "mv \"$appimage\" \"$HOME/Applications/\""
