#!/usr/bin/bash
#     _               ___
#    / \   _ __  _ __|_ _|_ __ ___   __ _  __ _  ___
#   / _ \ | '_ \| '_ \| || '_ ` _ \ / _` |/ _` |/ _ \
#  / ___ \| |_) | |_) | || | | | | | (_| | (_| |  __/
# /_/   \_\ .__/| .__/___|_| |_| |_|\__,_|\__, |\___|
#         |_|   |_|                       |___/
#  ___       _                       _
# |_ _|_ __ | |_ ___  __ _ _ __ __ _| |_ ___  _ __
#  | || '_ \| __/ _ \/ _` | '__/ _` | __/ _ \| '__|
#  | || | | | ||  __/ (_| | | | (_| | || (_) | |
# |___|_| |_|\__\___|\__, |_|  \__,_|\__\___/|_|
#                    |___/
#
# Author Andrianos Papamarkou
# Email: apapamarkou@yahoo.com
#

# Check dependencies
MISSING_DEPS=()
command -v git &> /dev/null || MISSING_DEPS+=("git")
command -v inotifywait &> /dev/null || MISSING_DEPS+=("inotify-tools")
command -v notify-send &> /dev/null || MISSING_DEPS+=("libnotify")

if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo "Missing dependencies: ${MISSING_DEPS[*]}"
    read -p "Install automatically? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if [ -f /etc/arch-release ]; then
            PKG="inotify-tools git libnotify"
            sudo pacman -S --needed $PKG
        elif [ -f /etc/debian_version ]; then
            PKG="inotify-tools git libnotify-bin"
            sudo apt install -y $PKG
        elif [ -f /etc/fedora-release ] || [ -f /etc/redhat-release ]; then
            PKG="inotify-tools git libnotify"
            sudo dnf install -y $PKG
        elif [ -f /etc/SUSE-brand ] || [ -f /etc/SuSE-release ]; then
            PKG="inotify-tools git libnotify-tools"
            sudo zypper install -y $PKG
        else
            echo "Unsupported distribution. Install manually: ${MISSING_DEPS[*]}"
            read -p "Continue anyway? (y/n): " -n 1 -r
            echo
            [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
        fi
    else
        exit 1
    fi
fi

SCRIPT_DIR="$(dirname "$(realpath "$0")")"

# Auto-detect if running from git repo or standalone
if [ -d "$SCRIPT_DIR/src" ]; then
    SRC_DIR="$SCRIPT_DIR/src"
else
    REPO_URL="https://github.com/apapamarkou/appimage-integrator.git"
    TEMP_DIR=$(mktemp -d)
    echo "Downloading appimage-integrator..."
    git clone "$REPO_URL" "$TEMP_DIR" || { echo "Failed to download"; exit 1; }
    SRC_DIR="$TEMP_DIR/src"
    trap "rm -rf $TEMP_DIR" EXIT
fi

# Parse arguments
INSTALL_MODE="user"
START_MODE="systemd"

while [[ $# -gt 0 ]]; do
    case $1 in
        -user) INSTALL_MODE="user"; shift ;;
        -system) INSTALL_MODE="system"; shift ;;
        -autostart) START_MODE="autostart"; shift ;;
        -systemd) START_MODE="systemd"; shift ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Check systemd support
if [ "$START_MODE" = "systemd" ] && ! command -v systemctl &> /dev/null; then
    echo "systemd not found. Falling back to autostart."
    START_MODE="autostart"
fi

# Set paths based on install mode
if [ "$INSTALL_MODE" = "system" ]; then
    BIN_DIR="/opt/appimage-integrator"
    CONFIG_DIR="/etc/appimage-integrator"
    sudo mkdir -p "$BIN_DIR" "$CONFIG_DIR"
else
    BIN_DIR="$HOME/.local/bin/appimage-integrator"
    CONFIG_DIR="$HOME/.config/appimage-integrator"
    mkdir -p "$BIN_DIR" "$CONFIG_DIR"
fi

# Copy scripts
for script in appimage-integrator-observer appimage-integrator-cleanup appimage-integrator-extract messages.*; do
    if [ "$INSTALL_MODE" = "system" ]; then
        sudo cp "$SRC_DIR/$script" "$BIN_DIR/"
        sudo chmod a+x "$BIN_DIR/appimage-integrator-"* 2>/dev/null
    else
        cp "$SRC_DIR/$script" "$BIN_DIR/"
        chmod a+x "$BIN_DIR/appimage-integrator-"*
    fi
done

# Copy config
if [ "$INSTALL_MODE" = "system" ]; then
    sudo cp "$SRC_DIR/appimage-integrator.conf" "$CONFIG_DIR/"
else
    cp "$SRC_DIR/appimage-integrator.conf" "$CONFIG_DIR/"
fi

mkdir -p "$HOME/Applications" "$HOME/.local/share/applications"

# Setup start mode
if [ "$START_MODE" = "autostart" ]; then
    AUTOSTART_DIR="$HOME/.config/autostart"
    mkdir -p "$AUTOSTART_DIR"
    cat <<EOF > "$AUTOSTART_DIR/Appimage-Integrator.desktop"
[Desktop Entry]
Type=Application
Name=Appimage integration
Comment=Appimage integration
Exec=$BIN_DIR/appimage-integrator-observer
StartupNotify=false
Terminal=false
Hidden=false
EOF
    chmod 644 "$AUTOSTART_DIR/Appimage-Integrator.desktop"
    $BIN_DIR/appimage-integrator-observer &
    echo "Autostart configured"
else
    SYSTEMD_DIR="$HOME/.config/systemd/user"
    mkdir -p "$SYSTEMD_DIR"
    cat <<EOF > "$SYSTEMD_DIR/appimage-integrator.service"
[Unit]
Description=AppImage Integrator
After=default.target

[Service]
Type=simple
ExecStart=$BIN_DIR/appimage-integrator-observer
Restart=on-failure

[Install]
WantedBy=default.target
EOF
    systemctl --user daemon-reload
    systemctl --user enable appimage-integrator.service
    systemctl --user start appimage-integrator.service
    sleep 1
    if systemctl --user is-active --quiet appimage-integrator.service; then
        echo "Service started successfully"
    else
        echo "Service failed to start"
        exit 1
    fi
fi

echo "Installation complete."
